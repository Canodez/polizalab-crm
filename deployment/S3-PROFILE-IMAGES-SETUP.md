# S3 Profile Images Bucket Setup

## Bucket Information

- **Bucket Name**: `polizalab-profile-images`
- **Region**: `us-east-1`
- **ARN**: `arn:aws:s3:::polizalab-profile-images`

## Security Configuration

### Public Access Block
All public access is blocked for security:
- BlockPublicAcls: `true`
- IgnorePublicAcls: `true`
- BlockPublicPolicy: `true`
- RestrictPublicBuckets: `true`

### Encryption
Server-side encryption enabled with AES256:
- Algorithm: `AES256`
- BucketKeyEnabled: `true`

### Versioning
Versioning is enabled to protect against accidental deletions and overwrites.

## CORS Configuration

The bucket is configured to accept requests from:
- `http://localhost:3000` (development)
- `https://d4srl7zbv9blh.cloudfront.net` (CloudFront)
- `https://crm.antesdefirmar.org` (custom domain)

Allowed methods: GET, PUT, POST, DELETE, HEAD

## Lifecycle Rules

### 1. Delete Old Versions
- **ID**: `DeleteOldVersions`
- **Action**: Delete non-current versions after 30 days
- **Purpose**: Reduce storage costs by cleaning up old versions

### 2. Abort Incomplete Multipart Uploads
- **ID**: `AbortIncompleteMultipartUpload`
- **Action**: Abort incomplete uploads after 7 days
- **Purpose**: Clean up failed uploads to reduce storage costs

## Access Pattern

Images will be uploaded using pre-signed URLs generated by the `profile-image-upload` Lambda function. This ensures:
- Secure, time-limited upload access
- No need for public bucket access
- Proper authentication and authorization

## Configuration Files

- `deployment/s3-profile-images-cors.json` - CORS configuration
- `deployment/s3-profile-images-lifecycle.json` - Lifecycle rules
- `deployment/s3-profile-images-policy.json` - Bucket policy template (for reference)

## Verification Commands

```bash
# Check bucket configuration
aws s3api get-bucket-versioning --bucket polizalab-profile-images
aws s3api get-bucket-encryption --bucket polizalab-profile-images
aws s3api get-bucket-cors --bucket polizalab-profile-images
aws s3api get-bucket-lifecycle-configuration --bucket polizalab-profile-images
aws s3api get-public-access-block --bucket polizalab-profile-images
```

## Next Steps

1. Deploy the `profile-image-upload` Lambda function
2. Grant the Lambda IAM role permissions to generate pre-signed URLs for this bucket
3. Test image upload flow from the frontend
